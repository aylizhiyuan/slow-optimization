{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","EventEmitter","PassThrough","Readable","nodeStream","unzip","tmp","iterateStream","parseSax","StyleManager","WorkbookPropertiesManager","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","input","options","worksheets","sharedStrings","hyperlinks","styles","entries","init","properties","createReadStream","Error","parse","eventType","value","emit","read","Symbol","asyncIterator","stream","_getStream","zip","Parse","forceStream","pipe","waitingWorkSheets","entry","match","sheetNo","path","_parseWorkbook","_parseSharedStrings","_parseStyles","_parseWorksheet","Promise","resolve","reject","file","err","fd","tempFileCleanupCallback","push","tempStream","createWriteStream","on","_parseHyperlinks","autodrain","fileStream","payload","_emitEntry","type","parseStream","inT","text","index","events","node","name","iterator","id","worksheetReader","workbook","hyperlinksReader","Options","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\r\nconst {EventEmitter} = require('events');\r\nconst {PassThrough, Readable} = require('readable-stream');\r\nconst nodeStream = require('stream');\r\nconst unzip = require('unzipper');\r\nconst tmp = require('tmp');\r\nconst iterateStream = require('../../utils/iterate-stream');\r\nconst parseSax = require('../../utils/parse-sax');\r\n\r\nconst StyleManager = require('../../xlsx/xform/style/styles-xform');\r\nconst WorkbookPropertiesManager = require('../../xlsx/xform/book/workbook-properties-xform');\r\n\r\nconst WorksheetReader = require('./worksheet-reader');\r\nconst HyperlinkReader = require('./hyperlink-reader');\r\n\r\ntmp.setGracefulCleanup();\r\n\r\nclass WorkbookReader extends EventEmitter {\r\n  constructor(input, options = {}) {\r\n    super();\r\n\r\n    this.input = input;\r\n\r\n    this.options = {\r\n      worksheets: 'emit',\r\n      sharedStrings: 'cache',\r\n      hyperlinks: 'ignore',\r\n      styles: 'ignore',\r\n      entries: 'ignore',\r\n      ...options,\r\n    };\r\n\r\n    this.styles = new StyleManager();\r\n    this.styles.init();\r\n\r\n    this.properties = new WorkbookPropertiesManager();\r\n  }\r\n\r\n  _getStream(input) {\r\n    if (input instanceof nodeStream.Readable || input instanceof Readable) {\r\n      return input;\r\n    }\r\n    if (typeof input === 'string') {\r\n      return fs.createReadStream(input);\r\n    }\r\n    throw new Error(`Could not recognise input: ${input}`);\r\n  }\r\n\r\n  async read(input, options) {\r\n    try {\r\n      for await (const {eventType, value} of this.parse(input, options)) {\r\n        switch (eventType) {\r\n          case 'shared-strings':\r\n            this.emit(eventType, value);\r\n            break;\r\n          case 'worksheet':\r\n            this.emit(eventType, value);\r\n            await value.read();\r\n            break;\r\n          case 'hyperlinks':\r\n            this.emit(eventType, value);\r\n            break;\r\n        }\r\n      }\r\n      this.emit('end');\r\n      this.emit('finished');\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  async *[Symbol.asyncIterator]() {\r\n    for await (const {eventType, value} of this.parse()) {\r\n      if (eventType === 'worksheet') {\r\n        yield value;\r\n      }\r\n    }\r\n  }\r\n\r\n  async *parse(input, options) {\r\n    if (options) this.options = options;\r\n    const stream = (this.stream = this._getStream(input || this.input));\r\n    const zip = unzip.Parse({forceStream: true});\r\n    stream.pipe(zip);\r\n\r\n    // worksheets, deferred for parsing after shared strings reading\r\n    const waitingWorkSheets = [];\r\n\r\n    for await (const entry of iterateStream(zip)) {\r\n      let match;\r\n      let sheetNo;\r\n      switch (entry.path) {\r\n        case '_rels/.rels':\r\n        case 'xl/_rels/workbook.xml.rels':\r\n          break;\r\n        case 'xl/workbook.xml':\r\n          await this._parseWorkbook(entry);\r\n          break;\r\n        case 'xl/sharedStrings.xml':\r\n          yield* this._parseSharedStrings(entry);\r\n          break;\r\n        case 'xl/styles.xml':\r\n          await this._parseStyles(entry);\r\n          break;\r\n        default:\r\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\r\n            sheetNo = match[1];\r\n            if (this.sharedStrings) {\r\n              yield* this._parseWorksheet(iterateStream(entry), sheetNo);\r\n            } else {\r\n              // create temp file for each worksheet\r\n              await new Promise((resolve, reject) => {\r\n                tmp.file((err, path, fd, tempFileCleanupCallback) => {\r\n                  if (err) {\r\n                    return reject(err);\r\n                  }\r\n                  waitingWorkSheets.push({sheetNo, path, tempFileCleanupCallback});\r\n\r\n                  const tempStream = fs.createWriteStream(path);\r\n                  entry.pipe(tempStream);\r\n                  return tempStream.on('finish', () => {\r\n                    return resolve();\r\n                  });\r\n                });\r\n              });\r\n            }\r\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\r\n            sheetNo = match[1];\r\n            yield* this._parseHyperlinks(iterateStream(entry), sheetNo);\r\n          }\r\n          break;\r\n      }\r\n      entry.autodrain();\r\n    }\r\n\r\n    for (const {sheetNo, path, tempFileCleanupCallback} of waitingWorkSheets) {\r\n      let fileStream = fs.createReadStream(path);\r\n      // TODO: Remove once node v8 is deprecated\r\n      // Detect and upgrade old fileStreams\r\n      if (!fileStream[Symbol.asyncIterator]) {\r\n        fileStream = fileStream.pipe(new PassThrough());\r\n      }\r\n      yield* this._parseWorksheet(fileStream, sheetNo);\r\n      tempFileCleanupCallback();\r\n    }\r\n  }\r\n\r\n  _emitEntry(payload) {\r\n    if (this.options.entries === 'emit') {\r\n      this.emit('entry', payload);\r\n    }\r\n  }\r\n\r\n  async _parseWorkbook(entry) {\r\n    this._emitEntry({type: 'workbook'});\r\n    await this.properties.parseStream(iterateStream(entry));\r\n  }\r\n\r\n  async *_parseSharedStrings(entry) {\r\n    this._emitEntry({type: 'shared-strings'});\r\n    switch (this.options.sharedStrings) {\r\n      case 'cache':\r\n        this.sharedStrings = [];\r\n        break;\r\n      case 'emit':\r\n        break;\r\n      default:\r\n        return;\r\n    }\r\n\r\n    let inT = false;\r\n    let text = null;\r\n    let index = 0;\r\n    for await (const events of parseSax(iterateStream(entry))) {\r\n      for (const {eventType, value} of events) {\r\n        if (eventType === 'opentag') {\r\n          const node = value;\r\n          if (node.name === 't') {\r\n            text = null;\r\n            inT = true;\r\n          }\r\n        } else if (eventType === 'text') {\r\n          text = text ? text + value : value;\r\n        } else if (eventType === 'closetag') {\r\n          const node = value;\r\n          if (inT && node.name === 't') {\r\n            if (this.options.sharedStrings === 'cache') {\r\n              this.sharedStrings.push(text);\r\n            } else if (this.options.sharedStrings === 'emit') {\r\n              yield {index: index++, text};\r\n            }\r\n            text = null;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  async _parseStyles(entry) {\r\n    this._emitEntry({type: 'styles'});\r\n    if (this.options.styles === 'cache') {\r\n      this.styles = new StyleManager();\r\n      await this.styles.parseStream(iterateStream(entry));\r\n    }\r\n  }\r\n\r\n  *_parseWorksheet(iterator, sheetNo) {\r\n    this._emitEntry({type: 'worksheet', id: sheetNo});\r\n    const worksheetReader = new WorksheetReader({workbook: this, id: sheetNo, iterator, options: this.options});\r\n    if (this.options.worksheets === 'emit') {\r\n      yield {eventType: 'worksheet', value: worksheetReader};\r\n    }\r\n  }\r\n\r\n  *_parseHyperlinks(iterator, sheetNo) {\r\n    this._emitEntry({type: 'hyperlinks', id: sheetNo});\r\n    const hyperlinksReader = new HyperlinkReader({workbook: this, id: sheetNo, iterator, options: this.options});\r\n    if (this.options.hyperlinks === 'emit') {\r\n      yield {eventType: 'hyperlinks', value: hyperlinksReader};\r\n    }\r\n  }\r\n}\r\n\r\n// for reference - these are the valid values for options\r\nWorkbookReader.Options = {\r\n  worksheets: ['emit', 'ignore'],\r\n  sharedStrings: ['cache', 'emit', 'ignore'],\r\n  hyperlinks: ['cache', 'emit', 'ignore'],\r\n  styles: ['cache', 'ignore'],\r\n  entries: ['emit', 'ignore'],\r\n};\r\n\r\nmodule.exports = WorkbookReader;\r\n"],"file":"workbook-reader.js"}